#-*- coding:utf-8 -*-
from django.shortcuts import render
from django.http import HttpResponseRedirect
from backend.models import UploadFile
from PIL import Image
import datetime
import os

def index(req):
  novel_list=UploadFile.objects.filter(typ="novel")
  novel_name=[]
  for novel in novel_list:
    novel_name.append(novel.name)
  pic_list=UploadFile.objects.filter(typ="image")
  return render(req, 'backend.html',{'pic_list':pic_list,'novel_list':novel_name})

def upload(req):
  a=UploadFile()
  domain_name=req.REQUEST.get('domain','xxx')
  if req.method == 'POST':
    content = req.FILES['ContextField']#picfile要和html里面一致
  if domain_name == 'homepage':
    fn='home.jpg'
    if not os.path.exists('upload'):     #路径不存在时创建一个
      os.makedirs('upload')
    f_path='upload/'+fn
    with open(f_path, 'wb+') as info:  
      for chunk in content.chunks(): 
        info.write(chunk)
  else:
    fnex = content.name.split('.')[-1]
    fn = datetime.datetime.now().strftime("%Y%m%d%H%M%S")
    a.timestamp = fn
    fn+='.'
    fn+=fnex
  if not os.path.exists('upload'):     #路径不存在时创建一个
    os.makedirs('upload')
  f_path='upload/'+fn
  with open(f_path, 'wb+') as info:  
    for chunk in content.chunks(): 
      info.write(chunk)
  if domain_name=='image':
    imagecache = Image.open(content)
    imagecache.thumbnail((250,250),Image.ANTIALIAS)
    imagecache.save('upload/'+'cache_'+fn,"jpeg")
  a.exname = fnex
  a.name = content.name.split('.')[0].encode('utf-8')
  a.typ = domain_name
  a.save()
  return HttpResponseRedirect('backend') 
# Create your views here.
